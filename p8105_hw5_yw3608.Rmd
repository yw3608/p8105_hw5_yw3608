---
title: "p8105_hw5_yw3608"
author: "Yuxuan Wang"
date: "11/18/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(readxl)
```

**Problem 1.1**
```{r, message = FALSE, warning = FALSE}
homicide_df = 
  read_csv("./data/homicide-data.csv", na = c("", "Unknown")) %>%
  mutate(
    city_state = str_c(city, state),
    resolution = case_when(
      disposition == "Closed without arrest"  ~ "unsolved",
      disposition == "Open/No arrest"         ~ "unsolved",
      disposition == "Closed by arrest"       ~ "solved"
    )
  ) %>%
  relocate(city_state) %>%
  filter(city_state != "TulsaAL")
```
**Describe the data** : The raw data shows that there are in total 12 variables. uid shows the id of the homicide id, reported_date show the date of the reported homicide date, victim_first show the first name of victim's first name. victim_race show the race of victim, victim-age represent the age. victim_sex represent the sex of victims. city represent the city where the case is reported. state show the state, lat is the latttitude, lon is the longitude and disposition shows weither the status of the case.


**Problem 1.2**
```{r}
baltimore_df = 
  homicide_df %>%
  filter(city_state == "BaltimoreMD")

baltimore_summary = 
  baltimore_df %>%
  summarize(
    unsolved = sum(resolution == "unsolved"),
    n = n()
  )

baltimore_test = 
  prop.test(
    x = baltimore_summary %>% pull(unsolved),
    n = baltimore_summary %>% pull(n)
  )

baltimore_test %>%
  broom::tidy() %>%
  knitr::kable()
```



**Problem 1.3**
```{r}
prop_test_func = function(city_df){
  
  city_summary = 
    city_df %>%
    summarize(
      unsolved = sum(resolution == "unsolved"),
      n = n()
      )
  
  city_test = 
    prop.test(
      x = city_summary %>% pull(unsolved),
      n = city_summary %>% pull(n)
    )
  
  return(city_test)
}

prop_test_func(baltimore_df)

homicide_df %>%
  filter(city_state == "AlbuquerqueNM") %>% 
  prop_test_func()
```


```{r}
results_df = 
  homicide_df %>% 
  nest(data = uid: resolution) %>% 
  mutate(
  test_results = map(data, prop_test_func),
  tidy_results = map(test_results, broom::tidy)
) %>% 
  select(city_state,tidy_results) %>% 
  unnest(tidy_results) %>% 
  select(city_state,estimate,starts_with("conf"))
  

```



**Problem 1.4**
```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state,estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```



**Problem 2.1 & 2.2**
```{r,warning=FALSE,message=FALSE}
data_f = 
  as_tibble(list.files("./data/zip.data/")) %>%
  mutate(
    text = map(.x = value, ~read_csv(str_c("./data/zip.data/", .x)))) %>% 
  unnest() %>% 
  separate(value, c("control_arm","subject_ID"), sep = "_")  %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observation") %>% 
    mutate(week = as.factor(week)) %>% 
  mutate(
    control_arm = case_when(
    control_arm == "con" ~ "control",
    control_arm == "exp" ~ "experiment")
  ) %>% 
  select(week, subject_ID, control_arm, observation) 
 
```

**Problem 2.3**
```{r}
plot = 
  data_f %>% 
  ggplot(aes(x = week, y = observation, group = control_arm, color = control_arm)) +
  geom_path() +
  labs(
    title = "Observations of control and experimental groups",
    x = "Week",
    y = "Observation"
  )
plot
ggsave("./plot.jpg")
```
**Difference**:According to the plot,the overall observation scores in experiment control arms is higher than that of in control groups.The overall trend of control group is "constant", however the overall trend of experiment group is increasing as the week increase(with time pass).


**Problem 3**
```{r}
set.seed(10)
iris_with_missing = 
  iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))


fillin_NA = 
  function(x) {
  
  if (is.character(x)) {
    x = ifelse(is.na(x), "virginica", x)
  } 
  else if(is.numeric(x)) {
    x = ifelse(is.na(x), mean(x, na.rm = TRUE), x)
    } 
  
    else {
    stop("Data entered not valid, should be number or letter")
  }
  
  return(x)   
  }
  

iris_finished = 
  iris_with_missing %>% 
  map_df(~ fillin_NA(.)) %>% 
  as_tibble()  %>% 
  knitr::kable()
iris_finished
```



